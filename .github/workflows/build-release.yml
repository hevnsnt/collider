name: Build Pro Release Binaries

on:
  push:
    branches: [ develop ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0-dev)'
        required: false
        default: 'dev'

env:
  BUILD_TYPE: Release

jobs:
  # ============================================================================
  # Linux x86_64 with CUDA
  # ============================================================================
  build-linux:
    runs-on: ubuntu-latest
    container:
      image: nvidia/cuda:12.6.0-devel-ubuntu22.04
    
    steps:
    - name: Install dependencies
      run: |
        apt-get update
        apt-get install -y \
          git \
          build-essential \
          libssl-dev \
          wget \
          file \
          ca-certificates \
          software-properties-common \
          gpg
        # Install CMake 3.28+ (Ubuntu 22.04 ships 3.22 which doesn't support CUDA C++20)
        wget -qO- https://apt.kitware.com/keys/kitware-archive-latest.asc | gpg --dearmor -o /usr/share/keyrings/kitware-archive-keyring.gpg
        echo "deb [signed-by=/usr/share/keyrings/kitware-archive-keyring.gpg] https://apt.kitware.com/ubuntu/ jammy main" > /etc/apt/sources.list.d/kitware.list
        apt-get update
        apt-get install -y cmake
        cmake --version
    
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Configure CMake
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
          -DCOLLIDER_EDITION_PRO=ON \
          -DCOLLIDER_USE_CUDA=ON \
          -DCOLLIDER_BUILD_TESTS=OFF \
          -DCOLLIDER_BUILD_BENCHMARKS=OFF \
          -DCOLLIDER_BUILD_TOOLS=OFF \
          -DCMAKE_CUDA_ARCHITECTURES="75;86;89"
    
    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}} --target collider_pro --parallel 4
    
    - name: Strip and verify
      run: |
        strip build/collider_pro
        ls -lh build/collider_pro
        file build/collider_pro
    
    - name: Upload Linux binary
      uses: actions/upload-artifact@v4
      with:
        name: collider_pro-linux-x64
        path: build/collider_pro
        retention-days: 30

  # ============================================================================
  # Windows x64 with CUDA
  # ============================================================================
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install CUDA Toolkit
      uses: Jimver/cuda-toolkit@v0.2.19
      with:
        cuda: '12.6.2'
        method: 'network'
        sub-packages: '["nvcc", "cudart", "visual_studio_integration"]'
    
    - name: Install vcpkg dependencies
      run: |
        vcpkg install --triplet x64-windows --no-print-usage
      shell: pwsh
    
    - name: Configure CMake
      run: |
        cmake -B build -G "Visual Studio 17 2022" -A x64 `
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} `
          -DCOLLIDER_EDITION_PRO=ON `
          -DCOLLIDER_USE_CUDA=ON `
          -DCOLLIDER_BUILD_TESTS=OFF `
          -DCOLLIDER_BUILD_BENCHMARKS=OFF `
          -DCOLLIDER_BUILD_TOOLS=OFF `
          -DCMAKE_TOOLCHAIN_FILE="C:/vcpkg/scripts/buildsystems/vcpkg.cmake" `
          -DVCPKG_TARGET_TRIPLET=x64-windows `
          -DCUDA_ARCHITECTURES="75;86;89"
      shell: pwsh
    
    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}} --target collider_pro --parallel 4
    
    - name: Verify binary
      run: |
        Get-Item build\Release\collider_pro.exe | Format-List Name, Length
      shell: pwsh
    
    - name: Upload Windows binary
      uses: actions/upload-artifact@v4
      with:
        name: collider_pro-windows-x64
        path: build/Release/collider_pro.exe
        retention-days: 30

  # ============================================================================
  # macOS ARM64 with Metal
  # ============================================================================
  build-macos:
    runs-on: macos-14  # Apple Silicon
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Install dependencies
      run: |
        brew update
        brew install cmake openssl
    
    - name: Configure CMake
      run: |
        export OPENSSL_ROOT_DIR=$(brew --prefix openssl)
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
          -DCOLLIDER_EDITION_PRO=ON \
          -DCOLLIDER_USE_CUDA=OFF \
          -DCOLLIDER_USE_METAL=ON \
          -DCOLLIDER_BUILD_TESTS=OFF \
          -DCOLLIDER_BUILD_BENCHMARKS=OFF \
          -DCOLLIDER_BUILD_TOOLS=OFF \
          -DOPENSSL_ROOT_DIR=$OPENSSL_ROOT_DIR
    
    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}} --target collider_pro --parallel 4
    
    - name: Verify binary
      run: |
        ls -lh build/collider_pro
        file build/collider_pro
        otool -L build/collider_pro || true
    
    - name: Upload macOS binary
      uses: actions/upload-artifact@v4
      with:
        name: collider_pro-macos-arm64
        path: build/collider_pro
        retention-days: 30

  # ============================================================================
  # Create Release with All Binaries
  # ============================================================================
  release:
    needs: [build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/
    
    - name: Prepare release files
      run: |
        mkdir -p release/
        
        # Linux
        cp artifacts/collider_pro-linux-x64/collider_pro release/collider_pro-linux-x64
        chmod +x release/collider_pro-linux-x64
        
        # Windows  
        cp artifacts/collider_pro-windows-x64/collider_pro.exe release/collider_pro-windows-x64.exe
        
        # macOS
        cp artifacts/collider_pro-macos-arm64/collider_pro release/collider_pro-macos-arm64
        chmod +x release/collider_pro-macos-arm64
        
        # Create checksums
        cd release/
        sha256sum collider_pro-* > SHA256SUMS.txt
        ls -la
        cat SHA256SUMS.txt
    
    - name: Determine version
      id: version
      run: |
        if [ "${{ github.event.inputs.version }}" != "" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="dev-$(date +%Y%m%d)-$(echo ${{ github.sha }} | cut -c1-7)"
        fi
        echo "version=v$VERSION" >> $GITHUB_OUTPUT
        echo "Version: v$VERSION"
    
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: "Collider Pro ${{ steps.version.outputs.version }}"
        body: |
          ## Collider Pro Release ${{ steps.version.outputs.version }}
          
          **üöÄ GPU-accelerated Bitcoin Puzzle Solver - Pro Edition**
          
          ### üì¶ Downloads:
          - **Linux x64 (CUDA)**: `collider_pro-linux-x64` 
          - **Windows x64 (CUDA)**: `collider_pro-windows-x64.exe`
          - **macOS ARM64 (Metal)**: `collider_pro-macos-arm64`
          
          ### üîç Verification:
          Download `SHA256SUMS.txt` and verify checksums:
          ```bash
          sha256sum -c SHA256SUMS.txt
          ```
          
          ### ‚ö° Features:
          - Solo puzzle solving (direct to wallet)
          - Brain wallet / passphrase cracking
          - Bloom filter integration
          - PCFG & Markov chain generation
          - Advanced rule engine
          - Multi-GPU support
          - Personalized licensing system
          
          ### üñ•Ô∏è System Requirements:
          - **Linux/Windows**: NVIDIA GPU with CUDA 12.6+ support
          - **macOS**: Apple Silicon Mac with Metal support
          - **GPU Memory**: 4GB+ recommended
          - **CUDA**: GTX 1060 or better (Linux/Windows)
          
          **Built from**: `${{ github.ref_name }}` @ `${{ github.sha }}`
        draft: false
        prerelease: true
        files: |
          release/*
    
    - name: Copy binaries for website patching
      run: |
        echo "üèóÔ∏è Binaries built and released!"
        echo "üìÅ For website integration, copy these to VPS:/opt/collider-binaries/"
        echo "   - collider_pro-linux-x64"
        echo "   - collider_pro-windows-x64.exe"  
        echo "   - collider_pro-macos-arm64"
        echo ""
        echo "üîó Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"